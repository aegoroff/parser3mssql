<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
	<!-- http://code.google.com/p/msbuildteamcitytasks/ -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildTeamCityTasks\MSBuild.TeamCity.Tasks.Targets"/>
	<PropertyGroup>
		<Major>1</Major>
		<Minor>1</Minor>
		<Build>0</Build>
		<Revision>0</Revision>
		<IsUpload>false</IsUpload>
		<ProjectName>parser3mssql</ProjectName>
		<Configuration>Release</Configuration>
		<ApiVersion>10</ApiVersion>
		<FtpLogin>1</FtpLogin>
		<FtpPassword>1</FtpPassword>
		<FtpFolder>ftp://somehost.com/folder</FtpFolder>
		<SvnPath>http://host.com/svn/parser3mssql/trunk</SvnPath>
		<BinaryArchive>parser3sql_$(ApiVersion)_$(Build)_win32_mssql.zip</BinaryArchive>
		<SourceArchive>parser3sql_$(ApiVersion)_$(Build)_win32_mssql_src.zip</SourceArchive>
		<ChangeLog>ChangeLog.txt</ChangeLog>
		<TestsFileNameWithoutExt>tests</TestsFileNameWithoutExt>
	</PropertyGroup>
	<ItemGroup>
		<ZipFiles Include="$(MSBuildProjectDirectory)\$(Configuration)\$(ProjectName).dll"/>
		<ZipFiles Include="$(MSBuildProjectDirectory)\README.txt"/>
		<ZipFiles Include="$(MSBuildProjectDirectory)\$(ChangeLog)"/>
	</ItemGroup>
	<ItemGroup>
		<SourceFiles Include="**\*.cpp"/>
		<SourceFiles Include="**\*.cc"/>
		<SourceFiles Include="**\*.h"/>
		<SourceFiles Include="**\*.C"/>
		<SourceFiles Include="**\*.rc"/>
		<SourceFiles Include="*.sln"/>
		<SourceFiles Include="**\*.vcproj"/>
		<SourceFiles Include="*.def"/>
		<SourceFiles Include="Lib\ChangeLog\*.*"/>
		<SourceFiles Include="Lib\gtest\lib\*.*"/>
		<SourceFiles Include="Lib\gtest\include\gtest\*.*"/>
		<SourceFiles Include="Lib\gtest\include\gtest\internal\*.*"/>
		<SourceFiles Include="Build.txt"/>
		<SourceFiles Include="$(ChangeLog)"/>
		<SourceFiles Include="parser3mssql.xml"/>
	</ItemGroup>
	<ItemGroup>
		<ResourceFile Include="$(MSBuildProjectDirectory)\parser3mssql.rc" />
	</ItemGroup>
	<Target Name="VersionUpdater">
		<FileUpdate
			Files="@(ResourceFile)"
			Regex='(FILEVERSION|PRODUCTVERSION)(\s*)(\d+),(\d+),(\d+),(\d+)'
			Encoding="windows-1251"
			ReplacementText='$1 $(Major),$(Minor),$(Build),$(Revision)' />
		<FileUpdate
			Files="@(ResourceFile)"
			Regex='VALUE(\s*)"(FileVersion|ProductVersion)",(\s*)"(\d+)\.(\d+)\.(\d+)\.(\d+)"'
			Encoding="windows-1251"
			ReplacementText='VALUE "$2", "$(Major).$(Minor).$(Build).$(Revision)"' />
	</Target>
	<Target Name="Compile" DependsOnTargets="VersionUpdater">
		<MSBuild Projects="parser3mssql.sln" Properties="Configuration=$(Configuration)" />
	</Target>
	<Target Name="UnitTests" DependsOnTargets="Compile">
		<Exec Command="$(Configuration)\$(TestsFileNameWithoutExt).exe --gtest_catch_exceptions --gtest_output=xml:" Timeout="30000" IgnoreExitCode="true"/>
		<ImportGoogleTests TestResultsPath="$(MSBuildProjectDirectory)\$(TestsFileNameWithoutExt).xml"/>
	</Target>
	<Target Name="Installer" DependsOnTargets="UnitTests">
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)"
			Command='cscript.exe Lib\ChangeLog\svn2cl.vbs --group-by-day -i --authors Lib\ChangeLog\authors.xml --output $(MSBuildProjectDirectory)\$(ChangeLog) $(SvnPath)' />
		<Message Text="SourceArchive: $(SourceArchive)"/>
		<Message Text="BinaryArchive: $(BinaryArchive)"/>
		<Zip
			Files="@(SourceFiles)"
			WorkingDirectory="$(MSBuildProjectDirectory)"
			ZipFileName="$(SourceArchive)"
			Flatten="false"
		/>
		<Zip Files="@(ZipFiles)" ZipFileName="$(BinaryArchive)" Flatten="true"/>
	</Target>
	<Target Name="Build" DependsOnTargets="Installer">
		<FtpUpload 
			LocalFile="$(BinaryArchive)"
			RemoteUri="$(FtpFolder)/parser3sql_$(ApiVersion)_0_win32_mssql.zip"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
		/>
		<FtpUpload 
			LocalFile="$(SourceArchive)"
			RemoteUri="$(FtpFolder)/parser3sql_$(ApiVersion)_0_win32_mssql_src.zip"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
		/>
		<Message Text="parser3mssql Build Complete"/>
	</Target>
</Project>